<mujoco model="JawExoModel_v1.0.0">

  <!-- 0. SIZE: Memory allocation and array dimensions -->
  <size
    memory="-1"
    nuserdata="0"
    nkey="0"
    nuser_body="-1"
    nuser_jnt="-1"
    nuser_geom="-1"
    nuser_site="-1"
    nuser_cam="-1"
    nuser_tendon="-1"
    nuser_actuator="-1"
    nuser_sensor="-1"
  />

  <option
    timestep="1.0e-4"
    apirate="100"
    impratio="1"
    gravity="0 0 -9.81"
    wind="0 0 0"
    magnetic="0 -0.5 0"
    density="0"
    viscosity="0"
    o_margin="0"
    o_solref="0.02 1"
    o_solimp="0.9 0.95 0.001 0.5 2"
    o_friction="1 0.005 0.0001"
    integrator="implicitfast"
    cone="elliptic"
    jacobian="auto"
    solver="Newton"
    iterations="100"
    tolerance="1e-5"
    ls_iterations="50"
    ls_tolerance="0.01"
    noslip_iterations="0"
    noslip_tolerance="1e-6"
    ccd_iterations="50"
    ccd_tolerance="1e-6"
    sdf_iterations="10"
    sdf_initpoints="40"
    actuatorgroupdisable=""
  >
    <!-- OPTION flags - Controls various simulation features -->
    <flag
      constraint="enable"
      equality="enable"
      frictionloss="enable"
      limit="enable"
      contact="enable"
      spring="enable"
      gravity="enable"
      clampctrl="enable"
      warmstart="enable"
      filterparent="enable"
      actuation="enable"
      refsafe="enable"
      sensor="enable"
      midphase="enable"
      nativeccd="enable"
      eulerdamp="enable"
      autoreset="enable"
      override="disable"
      energy="disable"
      fwdinv="disable"
      invdiscrete="disable"
      multiccd="disable"
      island="disable"
    />
  </option>

  <!-- COMPILER settings - Controls model compilation and processing -->
  <compiler
    autolimits="true"
    boundmass="0"
    boundinertia="0"
    settotalmass="-1"
    balanceinertia="false"
    strippath="false"
    coordinate="local"
    angle="degree"
    fitaabb="false"
    eulerseq="xyz"
    meshdir="../../../meshes/"
    texturedir="../../../textures/"
    assetdir="assets/"
    discardvisual="false"
    usethread="true"
    fusestatic="false"
    inertiafromgeom="auto"
    alignfree="true"
    inertiagrouprange="0 5"
    saveinertial="false"
  >
    <!-- LENGTHRANGE settings - Controls muscle length calculations -->
    <lengthrange
      mode="muscle"
      useexisting="true"
      uselimit="false"
      accel="50"
      maxforce="0"
      timeconst="0.1"
      timestep="0.005"
      inttotal="20"
      interval="2"
      tolrange="0.05"
    />
  </compiler>

  <visual>
    <global
      orthographic="false"
      fovy="35"
      azimuth="225"
      elevation="0"
      realtime="1"
      offwidth="640"
      offheight="480"
      ellipsoidinertia="true"
      bvactive="false"
    />
    <headlight diffuse="1 1 1" />
    <scale
      forcewidth="0.01"
      contactwidth="0.001"
      contactheight="0.1"
      com="0.1"
      camera="0.1"
      light="0.1"
      jointlength="1"
      jointwidth="0.01"
      actuatorwidth="0.075"
      framelength="0.2"
      framewidth="0.02"
      constraint="0.1"
    />
  </visual>

  <!--────────────────────────────────────────────────────────────────────────-->

  <!-- Assets -->
  <asset>

    <model name="jaw_model_rigid" file="../../anatomical/jaw/jaw_model_rigid.xml" />
    <model name="jaw_skin_model" file="../../anatomical/jaw/jaw_skin_model.xml" />

    <!-- Materials -->
    <!-- <material name="bone_material" rgba="0.5 0.5 0.5 1.0" /> -->

    <!-- Visualization meshes -->
    <mesh name="jaw_exo_fixture" file="exoskeleton/jaw/jaw_exo_fixture.obj" />
    <mesh name="jaw_exo_chin" file="exoskeleton/jaw/jaw_exo_chin.obj" />

    <!-- <model name="jaw_model_maxilla_teeth_coll_geoms"
      file="assets/jaw_model_maxilla_teeth_coll_geoms.xml" /> -->

  </asset>

  <!--────────────────────────────────────────────────────────────────────────-->

  <default>

    <default class="exo">
      <tendon
        width="0.001"
        rgba=".95 .3 .3 1"
        limited="false"
      />

      <site
        type="sphere"
        rgba="0.5 0.5 0.5 1"
        size="0.002"
        pos="0 0 0"
        quat="1 0 0 0"
      />

      <default class="exo_collision">
        <geom
          type="mesh"
          group="3"
          contype="1"
          conaffinity="1"
          condim="3"
          rgba="0.5 0.5 0.5 0.5"
          density="0"
          friction="1 0.005 0.0001"
          solref="0.02 1"
          solimp="0.9 0.95 0.001 0.5 2"
          margin="0"
          gap="0"
          pos="0 0 0"
          quat="1 0 0 0"
        />
      </default>
    </default>

  </default>

  <!--────────────────────────────────────────────────────────────────────────-->

  <worldbody>

    <body name="jaw_model_rigid" pos="0 0 0" quat="1 0 0 0">
      <attach model="jaw_model_rigid" body="skull" prefix="_" />
    </body>

    <body name="jaw_skin_model" pos="0 0 0" quat="1 0 0 0">
      <attach model="jaw_skin_model" body="jaw_skin" prefix="_" />
    </body>

    <body name="jaw_exo_chin" pos="0 0 0" quat="1 0 0 0">
      <geom
        name="jaw_exo_chin_vis"
        type="mesh"
        mesh="jaw_exo_chin"
        rgba="0.55 0.06 0.06 1.0"
        contype="0"
        conaffinity="0"
        group="1"
      />

      <freejoint
        name="jaw_exo_chin_freejoint"
        group="1"
        align="auto"
      />
    </body>

    <body name="jaw_exo" childclass="exo" pos="0 0 0" quat="1 0 0 0">
      <geom
        name="jaw_exo_fixture_vis"
        type="mesh"
        mesh="jaw_exo_fixture"
        rgba="0.55 0.06 0.06 1.0"
        contype="0"
        conaffinity="0"
        group="4"
      />

      <!-- <flexcomp
        name="jaw_exo_fixture_flexcomp"
        dim="2"
        dof="full"
        type="mesh"
        mass="0.04516"
        inertiabox="0.005"
        file="exoskeleton/jaw/jaw_exo_fixture.obj"
        pos="0 0 0"
        quat="1 0 0 0"
        radius="1.0e-3"
        rgba="0.55 0.06 0.06 0.95"
        rigid="true"
      >
        <contact
          internal="false"
          selfcollide="none"
          vertcollide="false"
          activelayers="1"
          contype="0"
          conaffinity="0"
          condim="3"
          friction="0.1 0.005 0.0001"
          solref="0.02 2"
          solimp="0.0 0.95 0.001 0.5 3"
          priority="1"
          margin="0"
          gap="0"
        />
      </flexcomp> -->

      <flexcomp
        name="jaw_exo_mask_flexcomp"
        dim="2"
        dof="full"
        type="mesh"
        mass="0.04516"
        inertiabox="0.005"
        file="exoskeleton/jaw/jaw_exo_mask_wo_chin.obj"
        pos="0 0 0"
        quat="1 0 0 0"
        radius="1.0e-3"
        rgba="0.55 0.06 0.06 1.0"
        rigid="false"
      >
        <contact
          internal="false"
          selfcollide="none"
          vertcollide="false"
          activelayers="1"
          contype="0"
          conaffinity="0"
          condim="3"
          friction="0.1 0.005 0.0001"
          solref="0.01 1.5"
          solimp="0.0 0.95 0.001 0.5 3"
          priority="1"
          margin="0"
          gap="0"
        />

        <!-- Either edge=true and damping=0 or 
         edge=false, damping>0, and Solid or Membrane plugin with stiffness>0 -->
        <edge
          equality="true"
          solref="-1e6 -2000"
          solimp="0.95 0.99 0.001 0.5 6"
          damping="10"
        />

        <!-- <pin
          id="0 2 3 9 14 15 30 31 32 33 34 35 36 96 97 98 99 100 101 183 184 185 186 187 188 273 274 
            275 276 277 278 334 336 341 344 345 360 361 362 363 364 365 366 415 416 417 418 419 420 502 
            503 504 505 506 507 591 592 593 594 595 596" /> -->
        <pin
          id="0 2 3 8 13 14 29 30 31 32 33 34 35 88 89 90 91 92 93 163 164 165 166 167 168 253 254 255 
          256 257 258 314 316 321 324 325 340 341 342 343 344 345 346 392 393 394 395 396 397 467 468 469 
          470 471 472 556 557 558 559 560 561"
        />

        <!-- Pin chin part to jaw_exo_chin -->
        <pin
          id="78 79 94 95 99 125 128 129 136 143 309 310 311 312 
          313 383 398 399 403 429 432 433 440 447 612 613 614 615"
        />
      </flexcomp>

      <!-- <site name="actuator_open_left" pos="0.0948729 -0.0147365 -0.149924" /> -->
      <site name="actuator_open_left" pos="0.0328247 0.0211895 -0.188688" />
    </body>

  </worldbody>

  <!--────────────────────────────────────────────────────────────────────────-->

  <equality>
    <!-- Not imported ('body/attach') with the skin model, but needed for the skin to work -->
    <flex flex="jaw_skin_flexcomp" solref="-1e6 -2e3" solimp="0.95 0.99 0.001 0.5 6" />

    <weld
      name="jaw_exo_chin_weld"
      solref="0.002 1"
      solimp="0.95 0.99 0.001 0.5 5"
      body1="jaw_exo_chin"
      body2="_mandible"
      torquescale="1.0"
    />
  </equality>

  <!--────────────────────────────────────────────────────────────────────────-->

  <contact>
    <!-- <exclude body1="jaw_exo" body2="_skull" /> -->
    <!-- <exclude body1="_jaw_skin" body2="_skull" /> -->

    <!-- <exclude body1="jaw_exo" body2="_jaw_skin" /> -->
    <!-- <exclude body1="jaw_exo" body2="jaw_exo" /> -->
  </contact>

  <!--────────────────────────────────────────────────────────────────────────-->

  <tendon>

  </tendon>

  <!--────────────────────────────────────────────────────────────────────────-->

  <actuator>

  </actuator>

</mujoco>